openapi: 3.0.0
info:
  title: Run Sheet Planner API
  description: API for planning and creating optimized run sheets
  version: 1.0.0
servers:
  - url: https://gsbpchneovtpqgnyfttp.supabase.co/functions/v1
    description: Supabase Edge Functions - Run Sheet Planner

paths:
  /create-tasks-from-clusters:
    post:
      operationId: create_tasks_from_clusters
      summary: Convert reviewed clusters into tasks
      description: Creates task records from reviewed clusters that are ready for scheduling. Can be called without a request body to convert all reviewed clusters.
      responses:
        '200':
          description: Tasks created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  tasks_created:
                    type: integer
                  tasks:
                    type: array
                    items:
                      type: object
        '401':
          description: Unauthorized
        '500':
          description: Server error

  /get-pending-tasks:
    get:
      operationId: get_pending_tasks
      summary: Get pending approved tasks
      description: Retrieve all approved tasks that need to be scheduled into run sheets. Use this to see what work needs to be planned. All parameters are optional - omit them to get all tasks.
      parameters:
        - name: status
          in: query
          description: Filter by task status (approved, pending_schedule, or scheduled). Omit this parameter to get all statuses.
          required: false
          schema:
            type: string
        - name: priority
          in: query
          description: Filter by priority level (today, 48h, week, or proactive). Omit this parameter to get all priorities.
          required: false
          schema:
            type: string
        - name: zone
          in: query
          description: Filter by zone/area. Omit this parameter to get all zones.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of pending tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  tasks:
                    type: array
                    items:
                      type: object
                      properties:
                        task_id:
                          type: string
                        complaint_id:
                          type: string
                        category:
                          type: string
                        location:
                          type: string
                        zone:
                          type: string
                        priority:
                          type: string
                        severity:
                          type: integer
                        created_at:
                          type: string
                          format: date-time
                  total_count:
                    type: integer
        '401':
          description: Unauthorized
        '500':
          description: Server error

  /get-team-availability:
    get:
      operationId: get_team_availability
      summary: Get team availability
      description: Retrieve available teams and their capacity for scheduling. Defaults to today's date and AM window if not specified. Use this to determine how many tasks each team can handle.
      parameters:
        - name: date
          in: query
          description: Date to check availability in format YYYY-MM-DD (e.g., 2026-01-28). Omit this parameter to default to today.
          required: false
          schema:
            type: string
        - name: window
          in: query
          description: Time window, either AM or PM. Omit this parameter to default to AM.
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Team availability information
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  date:
                    type: string
                  window:
                    type: string
                  teams:
                    type: array
                    items:
                      type: object
                      properties:
                        team_id:
                          type: string
                        team_name:
                          type: string
                        members_count:
                          type: integer
                        max_tasks:
                          type: integer
                        assigned_tasks:
                          type: integer
                        available_capacity:
                          type: integer
                        primary_zone:
                          type: string
                  total_capacity:
                    type: integer
        '401':
          description: Unauthorized
        '500':
          description: Server error

  /create-run-sheet:
    post:
      operationId: create_run_sheet
      summary: Create a new draft run sheet
      description: Generate and save an optimized draft run sheet for a team. The run sheet will be created with status 'draft' for supervisor review before dispatch.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - team_id
                - date
                - time_window
                - task_ids
              properties:
                team_id:
                  type: string
                  description: UUID of the team assigned to this run sheet
                  example: "47cab873-a26f-4380-9586-823885fdc49f"
                date:
                  type: string
                  format: date
                  description: Date for the run sheet in YYYY-MM-DD format
                  example: "2026-01-28"
                time_window:
                  type: string
                  description: Time window (AM or PM)
                  enum: ["AM", "PM"]
                  example: "AM"
                task_ids:
                  type: array
                  description: Ordered list of task UUIDs to include in the run sheet
                  items:
                    type: string
                  example: ["a1000001-0000-0000-0000-000000000001", "a1000001-0000-0000-0000-000000000002"]
                zones_covered:
                  type: array
                  description: List of zones covered by this run sheet
                  items:
                    type: string
                  example: ["Ang Mo Kio", "Bishan"]
                notes:
                  type: string
                  description: Planning notes or special instructions
                  example: "Prioritize drain tasks due to rain forecast"
      responses:
        '200':
          description: Run sheet created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  run_sheet_id:
                    type: string
                  message:
                    type: string
                  capacity_used_percent:
                    type: number
        '400':
          description: Bad request - invalid parameters or team capacity exceeded
        '401':
          description: Unauthorized
        '409':
          description: Run sheet already exists for this team/date/window
        '500':
          description: Server error

  /get-run-sheets:
    get:
      operationId: get_run_sheets
      summary: Get run sheets
      description: Retrieve run sheets by date, team, or status. Use status='draft' to see run sheets ready for review.
      parameters:
        - name: date
          in: query
          description: Filter by date (YYYY-MM-DD). Omit to get all dates.
          required: false
          schema:
            type: string
            format: date
        - name: team_id
          in: query
          description: Filter by team UUID. Omit to get all teams.
          required: false
          schema:
            type: string
        - name: status
          in: query
          description: Filter by status (draft, dispatched, in_progress, or completed). Omit to get all statuses.
          required: false
          schema:
            type: string
            enum: ["draft", "dispatched", "in_progress", "completed"]
      responses:
        '200':
          description: List of run sheets
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  run_sheets:
                    type: array
                    items:
                      type: object
                      properties:
                        run_sheet_id:
                          type: string
                        team_id:
                          type: string
                        team_name:
                          type: string
                        date:
                          type: string
                        window:
                          type: string
                        status:
                          type: string
                        total_tasks:
                          type: integer
                        completed_tasks:
                          type: integer
                        zones_covered:
                          type: array
                          items:
                            type: string
                        capacity_used_percent:
                          type: number
        '401':
          description: Unauthorized
        '500':
          description: Server error

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - BearerAuth: []
